<!-- Firebase SDK (ä½¿ç”¨è¼ƒç©©å®šçš„ 10.12.2 ç‰ˆæœ¬ï¼Œé¿å… CDN æ‰¾ä¸åˆ°æª”æ¡ˆ) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCp3-jUSRISCLXLgky_N25H1xjYuUC3jaI",
            authDomain: "travel-8eaef.firebaseapp.com",
            projectId: "travel-8eaef",
            storageBucket: "travel-8eaef.firebasestorage.app",
            messagingSenderId: "151062172132",
            appId: "1:151062172132:web:9bcda7d1de3eec31b037f1",
            measurementId: "G-CCGZFCJYQ8"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            // å°‡ Firebase åŠŸèƒ½æŽ›è¼‰åˆ° window ä»¥ä¾¿ Vue ä½¿ç”¨
            window.fb = { auth, db, signInAnonymously, signOut, onAuthStateChanged, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, arrayUnion, getDoc };
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) {
            console.error("Firebase Error:", e);
            alert("Init Failed: " + e.message);
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'main-bg': '#F5F5F7', 
                        'card-bg': '#FFFFFF', 
                        'accent': '#6366f1',
                        'border': '#E5E7EB', 
                        'text-main': '#1F2937', 
                        'text-sec': '#6B7280',
                        'input-bg': '#FFFFFF', 
                        'flight-bg': '#E0E7FF'
                    },
                    boxShadow: { 'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.1)', 'hard': '3px 3px 0px 0px #1F2937' }
                }
            }
        }
    </script>

    <style>
        body { background-color: var(--main-bg); color: var(--text-main); font-family: 'Inter', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: env(safe-area-inset-bottom); overscroll-behavior-y: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; } 
        
        input, select, textarea { 
            background: var(--input-bg); color: var(--text-main); 
            border: 1px solid #D1D5DB; 
            padding: 0.8rem;
            border-radius: 0.75rem; font-weight: 600; outline: none; 
            transition: all 0.2s; width: 100%; font-size: 15px !important; 
        }
        input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        
        input[type="date"] { -webkit-appearance: none; position: relative; min-height: 48px; line-height: 1.2; }
        input[type="date"]:invalid::-webkit-datetime-edit { color: transparent; }
        input[type="date"]:invalid::before { content: attr(placeholder); position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); color: #9CA3AF; pointer-events: none; }
        input[type="date"]:focus::-webkit-datetime-edit, input[type="date"]:valid::-webkit-datetime-edit { color: var(--text-main) !important; }
        input[type="date"]:focus::before, input[type="date"]:valid::before { display: none; }

        .sortable-ghost { opacity: 0.4; background: #E0E7FF; }
        
        #draggable-btn { position: fixed; z-index: 9999; touch-action: none; transition: transform 0.1s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        #app-loading { position: fixed; inset: 0; background: #F5F5F7; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; font-weight: 900; color: #374151; transition: opacity 0.5s; }
        .hidden-load { opacity: 0; pointer-events: none; }
        [v-cloak] { display: none; }
    </style>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;

        const i18n = {
            'zh-TW': { trips:'æˆ‘çš„è¡Œç¨‹', newTrip:'æ–°å¢žè¡Œç¨‹', v:'æ†‘è­‰ç¥¨åˆ¸', settings:'è¨­å®š', save:'å„²å­˜', cancel:'å–æ¶ˆ', destination:'ç›®çš„åœ°', weather:'ç•¶åœ°å¤©æ°£', itinerary:'æ¯æ—¥è¡Œç¨‹', budget:'è¨˜å¸³', flights:'èˆªç­', hotels:'ä½å®¿', wishlist:'è¨±é¡˜æ¸…å–®', vouchers:'ç¥¨åˆ¸åŠæ†‘è­‰', packing:'è¡Œå‰æº–å‚™', enterId:'è¼¸å…¥è¡Œç¨‹ ID åŠ å…¥', noTrips:'ç›®å‰æ²’æœ‰è¡Œç¨‹', enterItem:'è¼¸å…¥è¡Œç¨‹...', paidFor:'å¹«ä»˜', totalExpense:'ç¸½æ”¯å‡º', members:'æˆå“¡', history:'æ­·å²ç´€éŒ„', note:'å‚™è¨»', sightseeing:'æ™¯é»ž', food:'åƒé£¯', shopping:'è³¼ç‰©' },
            'en': { trips:'MY TRIPS', newTrip:'NEW TRIP', v:'VOUCHERS', settings:'SETTINGS', save:'SAVE', cancel:'CANCEL', destination:'Destination', weather:'WEATHER', itinerary:'ITINERARY', budget:'BUDGET', flights:'FLIGHTS', hotels:'HOTELS', wishlist:'WISHLIST', vouchers:'TICKETS', packing:'PACKING', enterId:'Enter Trip ID', noTrips:'No trips.', enterItem:'Enter item...', paidFor:'paid for', totalExpense:'Total', members:'Members', history:'History', note:'Note', sightseeing:'Sightseeing', food:'Food', shopping:'Shopping' },
            'ja': { trips:'æ—…è¡Œä¸€è¦§', newTrip:'æ–°ã—ã„æ—…', v:'ãƒã‚±ãƒƒãƒˆ', settings:'è¨­å®š', save:'ä¿å­˜', cancel:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', destination:'ç›®çš„åœ°', weather:'å¤©æ°—', itinerary:'æ—…ç¨‹è¡¨', budget:'äºˆç®—', flights:'ãƒ•ãƒ©ã‚¤ãƒˆ', hotels:'å®¿æ³Š', wishlist:'ã»ã—ã„ç‰©', vouchers:'ãƒã‚±ãƒƒãƒˆ', packing:'æŒã¡ç‰©', enterId:'IDå…¥åŠ›', noTrips:'æ—…è¡Œãªã—', enterItem:'å…¥åŠ›...', paidFor:'ä»£è¡Œ', totalExpense:'åˆè¨ˆ', members:'ãƒ¡ãƒ³ãƒãƒ¼', history:'å±¥æ­´', note:'ãƒ¡ãƒ¢', sightseeing:'è¦³å…‰', food:'é£Ÿäº‹', shopping:'è²·ã„ç‰©' },
            'ko': { trips:'ë‚˜ì˜ ì—¬í–‰', newTrip:'ìƒˆ ì—¬í–‰', v:'ë°”ìš°ì²˜', settings:'ì„¤ì •', save:'ì €ìž¥', cancel:'ì·¨ì†Œ', destination:'ëª©ì ì§€', weather:'ë‚ ì”¨', itinerary:'ì¼ì •', budget:'ì˜ˆì‚°', flights:'í•­ê³µíŽ¸', hotels:'ìˆ™ì†Œ', wishlist:'ìœ„ì‹œë¦¬ìŠ¤íŠ¸', vouchers:'í‹°ì¼“/ë°”ìš°ì²˜', packing:'ì¤€ë¹„ë¬¼', enterId:'IDìž…ë ¥', noTrips:'ì—¬í–‰ ì—†ìŒ', enterItem:'ìž…ë ¥...', paidFor:'ëŒ€ì‹  ê²°ì œ', totalExpense:'ì´ì•¡', members:'ë©¤ë²„', history:'ê¸°ë¡', note:'ë©”ëª¨', sightseeing:'ê´€ê´‘', food:'ì‹ì‚¬', shopping:'ì‡¼í•‘' }
        };
        const langNames = { 'zh-TW':'ç¹é«”ä¸­æ–‡', 'en':'English', 'ja':'æ—¥æœ¬èªž', 'ko':'í•œêµ­ì–´' };

        createApp({
            setup() {
                const user = ref(null); const trips = ref([]); const currentTrip = ref({});
                const currentView = ref('home'); const loading = ref(false);
                const isModalOpen = ref(false); const showSettings = ref(false);
                const showCalculator = ref(false); const showFlightModal = ref(false); const showHotelModal = ref(false); const showDayReorderModal = ref(false);
                const selectedDate = ref(''); const joinTripId = ref(''); 
                const firebaseStatus = ref('connecting'); const errorMessage = ref('');
                const loginBtnText = computed(() => firebaseStatus.value === 'connecting' ? 'Connecting...' : 'START');
                const currentLang = ref('zh-TW'); const t = (key) => i18n[currentLang.value][key] || key;
                
                const form = ref({ destination: '', startDate: '', endDate: '', coverImage: null });
                const newItem = ref({ time: '10:00', text: '', category: 'sightseeing' });
                
                // Flight Data
                const isEditingFlight = ref(false); 
                const simpleFlight = ref({ code:'', airline:'', date:'', time:'' });
                const editFlightData = ref({});
                const editFlightIndex = ref(-1);

                // Models
                const newHotel = ref({ name:'', address:'', checkIn:'', checkOut:'', cost:'', photo:null });
                const newVoucher = ref({ title:'', note:'', file:null });
                const genericInput = ref('');
                const newMemberName = ref('');
                const calcCurrency = ref('JPY'); const calcInput = ref(''); const expenseNote = ref(''); const expensePayer = ref('Me'); const expenseSplitters = ref(['Me']); 
                const rates = { JPY: 0.22, KRW: 0.024, USD: 32.1, EUR: 34.5, THB: 0.9 };
                
                let unsubscribeTrips = null; let unsubscribeCurrentTrip = null;

                onMounted(() => {
                    window.addEventListener('firebase-ready', () => {
                        firebaseStatus.value = 'ready';
                        if(window.fb && window.fb.auth) {
                            window.fb.onAuthStateChanged(window.fb.auth, (u) => { 
                                user.value = u; 
                                if(u) loadTrips(); 
                            });
                        }
                    });
                    // å¦‚æžœ Vue æŽ›è¼‰æ™‚ window.fb å·²ç¶“æº–å‚™å¥½ï¼ˆé¿å… Race Conditionï¼‰
                    if(window.fb) {
                        firebaseStatus.value = 'ready';
                        window.fb.onAuthStateChanged(window.fb.auth, (u) => { user.value = u; if(u) loadTrips(); });
                    }
                    setTimeout(() => document.getElementById('app-loading').classList.add('hidden-load'), 1000);
                });

                const login = async () => { 
                    try { 
                        if (!window.fb) throw new Error("Firebase not initialized");
                        await window.fb.signInAnonymously(window.fb.auth); 
                    } catch (e) { 
                        console.error(e);
                        errorMessage.value = e.message; 
                    } 
                };
                const logout = () => window.fb.signOut(window.fb.auth);

                const loadTrips = () => {
                    loading.value = true;
                    if(unsubscribeTrips) unsubscribeTrips();
                    const q = window.fb.query(window.fb.collection(window.fb.db, "trips"), window.fb.where("members", "array-contains", user.value.uid));
                    unsubscribeTrips = window.fb.onSnapshot(q, (snap) => { trips.value = snap.docs.map(d => ({ id: d.id, ...d.data() })); loading.value = false; });
                };

                const backToHome = () => {
                    currentView.value = 'home';
                    if(unsubscribeCurrentTrip) { unsubscribeCurrentTrip(); unsubscribeCurrentTrip = null; }
                    currentTrip.value = {};
                    loadTrips();
                };

                const openTrip = (trip) => {
                    if(unsubscribeCurrentTrip) unsubscribeCurrentTrip();
                    unsubscribeCurrentTrip = window.fb.onSnapshot(window.fb.doc(window.fb.db, "trips", trip.id), (doc) => {
                        if(doc.exists()) { currentTrip.value = { id: doc.id, ...doc.data() }; if(!selectedDate.value) selectedDate.value = formatDate(currentTrip.value.startDate); }
                    });
                    currentView.value = 'dashboard';
                };

                // â˜…â˜…â˜… ä¿®æ­£é»žï¼šåŠ å…¥é€™å€‹ç¼ºå¤±çš„å‡½æ•¸ â˜…â˜…â˜…
                const openNewTripModal = () => {
                    isModalOpen.value = true;
                };

                const createCloudTrip = async () => {
                    if (!form.value.destination || !form.value.startDate) return;
                    await window.fb.addDoc(window.fb.collection(window.fb.db, "trips"), { ...form.value, members: [user.value.uid], itinerary: {}, todos: [], expenses: [], flights: [], hotels: [], vouchers: [], wishlist: [], createdAt: Date.now() });
                    isModalOpen.value = false;
                };
                
                const deleteTrip = async (trip) => { if(confirm('Delete?')) await window.fb.deleteDoc(window.fb.doc(window.fb.db, "trips", trip.id)); };
                const syncUpdate = async () => { if(currentTrip.value.id) await window.fb.updateDoc(window.fb.doc(window.fb.db, "trips", currentTrip.value.id), { ...currentTrip.value }); };

                // Flights
                const addSimpleFlight = () => {
                    if(!currentTrip.value.flights) currentTrip.value.flights = [];
                    currentTrip.value.flights.push({ ...simpleFlight.value, origin:'', dest:'', arrTime:'', baggage:'', aircraft:'', cost:'' });
                    simpleFlight.value = { code:'', airline:'', date:'', time:'' };
                    syncUpdate();
                };
                const openFlightDetail = (f, i) => { editFlightData.value = { ...f }; editFlightIndex.value = i; isEditingFlight.value = true; };
                const saveFlightDetail = () => { if(editFlightIndex.value > -1) { currentTrip.value.flights[editFlightIndex.value] = { ...editFlightData.value }; syncUpdate(); } isEditingFlight.value = false; };
                const deleteCurrentFlight = () => { currentTrip.value.flights.splice(editFlightIndex.value, 1); syncUpdate(); isEditingFlight.value = false; };

                // Vouchers
                const handleVoucherFile = (e) => { const f = e.target.files[0]; if(f) compressAndConvertToBase64(f, (b) => newVoucher.value.file = b); };
                const addVoucher = () => { if(!currentTrip.value.vouchers) currentTrip.value.vouchers = []; currentTrip.value.vouchers.push({ ...newVoucher.value }); newVoucher.value = { title:'', note:'', file:null }; syncUpdate(); };
                const removeVoucher = (i) => { currentTrip.value.vouchers.splice(i, 1); syncUpdate(); };

                // Draggable
                const dragBtn = ref(null);
                const startDrag = (e) => { const touch = e.touches[0]; const btn = dragBtn.value; const rect = btn.getBoundingClientRect(); btn.dataset.startX = touch.clientX - rect.left; btn.dataset.startY = touch.clientY - rect.top; };
                const onDrag = (e) => { e.preventDefault(); const touch = e.touches[0]; const btn = dragBtn.value; const x = touch.clientX - parseFloat(btn.dataset.startX); const y = touch.clientY - parseFloat(btn.dataset.startY); btn.style.position = 'fixed'; btn.style.left = `${x}px`; btn.style.top = `${y}px`; btn.style.right = 'auto'; btn.style.bottom = 'auto'; };
                const endDrag = () => { };
                const handleClickCalc = () => { showCalculator.value = true; };

                // Helpers
                const compressAndConvertToBase64 = (file, cb) => { const r = new FileReader(); r.onload = (e) => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const s = 600/i.width; c.width=600; c.height=i.height*s; ctx.drawImage(i,0,0,c.width,c.height); cb(c.toDataURL('image/jpeg',0.6)); }; i.src = e.target.result; }; r.readAsDataURL(file); };
                const formatDate = (s) => s ? s.replace(/-/g, '/') : '';
                const getDays = (s,e) => { const d1=new Date(s), d2=new Date(e); return isNaN(d1)||isNaN(d2)?0:Math.floor((d2-d1)/86400000)+1; };
                const copyId = () => navigator.clipboard.writeText(currentTrip.value.id);
                
                // Itinerary
                const tripDates = computed(() => { if(!currentTrip.value.startDate || !currentTrip.value.endDate) return []; const d = []; let c = new Date(currentTrip.value.startDate); const e = new Date(currentTrip.value.endDate); while(c <= e) { d.push(formatDate(c.toISOString().split('T')[0])); c.setDate(c.getDate()+1); } return d; });
                const getDayItems = () => (currentTrip.value.itinerary && currentTrip.value.itinerary[selectedDate.value]) || [];
                const saveItem = () => { if(!newItem.value.text)return; if(!currentTrip.value.itinerary[selectedDate.value]) currentTrip.value.itinerary[selectedDate.value]=[]; currentTrip.value.itinerary[selectedDate.value].push({id:Date.now(), ...newItem.value, categoryEmoji: newItem.value.category==='food'?'ðŸ´':(newItem.value.category==='shopping'?'ðŸ›ï¸':'ðŸ“¸'), travelMode:'ðŸš—', isEditingNote:false}); currentTrip.value.itinerary[selectedDate.value].sort((a,b)=>a.time.localeCompare(b.time)); syncUpdate(); newItem.value.text=''; };
                const deleteItem = (i) => { currentTrip.value.itinerary[selectedDate.value].splice(i,1); syncUpdate(); };
                const toggleNote = (i) => i.showNote = !i.showNote;
                const handleItemImage = (e, i) => { const f = e.target.files[0]; if(f) compressAndConvertToBase64(f, (b) => { i.imageUrl = b; syncUpdate(); }); };
                const changeToItinerary = async () => { currentView.value='itinerary'; await nextTick(); new Sortable(document.getElementById('sortable-list'), { animation:150, ghostClass:'sortable-ghost', handle:'.group', onEnd:(e)=>{ const l = currentTrip.value.itinerary[selectedDate.value]; l.splice(e.newIndex, 0, l.splice(e.oldIndex, 1)[0]); syncUpdate(); }}); };

                // Budget
                const totalExpense = computed(() => (currentTrip.value.expenses||[]).reduce((a,b)=>a+b.twd,0));
                const groupedTotals = computed(() => { const g={}; (currentTrip.value.expenses||[]).forEach(e=>{ if(e.currency && e.currency!=='TWD') g[e.currency]=(g[e.currency]||0)+parseFloat(e.original); }); return g; });
                const handleCalc = (b) => { if(b==='C')calcInput.value=''; else if(b==='DEL')calcInput.value=calcInput.value.slice(0,-1); else calcInput.value+=b; };
                const calculateTWD = computed(() => Math.round((parseFloat(calcInput.value)||0) * (rates[calcCurrency.value] || 1)));
                const saveExpense = () => { if(!currentTrip.value.expenses) currentTrip.value.expenses=[]; currentTrip.value.expenses.push({ note:expenseNote.value||'Gen', twd:calculateTWD.value, original:calcInput.value, currency:calcCurrency.value, payer:expensePayer.value, splitters:[...expenseSplitters.value] }); syncUpdate(); showCalculator.value=false; calcInput.value=''; };
                const deleteExpense = (i) => { currentTrip.value.expenses.splice((currentTrip.value.expenses.length-1)-i,1); syncUpdate(); };
                const addMember = () => { if(newMemberName.value){ if(!currentTrip.value.members)currentTrip.value.members=['Me']; currentTrip.value.members.push(newMemberName.value); syncUpdate(); newMemberName.value=''; }};
                const removeMember = (i) => { currentTrip.value.members.splice(i,1); syncUpdate(); };

                // Hotel
                const addHotel = () => { if(!currentTrip.value.hotels)currentTrip.value.hotels=[]; currentTrip.value.hotels.push({...newHotel.value}); newHotel.value={name:'',address:'',checkIn:'',checkOut:'',cost:'',photo:null}; syncUpdate(); };
                const removeHotel = (i) => { currentTrip.value.hotels.splice(i,1); syncUpdate(); };
                const handleHotelPhoto = (e) => { const f = e.target.files[0]; if(f) compressAndConvertToBase64(f, (b) => newHotel.value.photo = b); };

                // Packing/Wishlist
                const getGenericList = () => { const key = currentView.value === 'packing_list' ? 'todos' : 'wishlist'; return currentTrip.value[key] || []; };
                const addGenericItem = () => { if(!genericInput.value) return; const key = currentView.value === 'packing_list' ? 'todos' : 'wishlist'; if(!currentTrip.value[key]) currentTrip.value[key] = []; currentTrip.value[key].push({ text: genericInput.value, done: false }); genericInput.value = ''; syncUpdate(); };
                const removeGenericItem = (i) => { const key = currentView.value === 'packing_list' ? 'todos' : 'wishlist'; currentTrip.value[key].splice(i, 1); syncUpdate(); };

                return {
                    user, login, logout, trips, currentTrip, currentView, loading, isModalOpen, showSettings, showCalculator, showFlightModal, showHotelModal, showDayReorderModal, selectedDate, joinTripId, firebaseStatus, errorMessage, loginBtnText, t, langNames, currentLang,
                    form, newItem, openNewTripModal, createCloudTrip, deleteTrip, openTrip, backToHome, copyId, getDays, formatDate,
                    tripDates, getDayItems, saveItem, deleteItem, toggleNote, handleItemImage, changeToItinerary,
                    isEditingFlight, simpleFlight, editFlightData, addSimpleFlight, openFlightDetail, saveFlightDetail, deleteCurrentFlight, handleVoucherFile, addVoucher, removeVoucher, newVoucher,
                    newHotel, addHotel, removeHotel, handleHotelPhoto,
                    totalExpense, groupedTotals, handleCalc, calcInput, calcCurrency, calculateTWD, expenseNote, expensePayer, expenseSplitters, saveExpense, deleteExpense, newMemberName, addMember, removeMember,
                    genericInput, getGenericList, addGenericItem, removeGenericItem, syncUpdate,
                    openTool: (t) => currentView.value = (t==='budget'?'budget_detail':(t==='packing'?'packing_list':t)), closeTools: () => showCalculator.value = false,
                    dragBtn, startDrag, onDrag, endDrag, handleClickCalc, openMap: (txt) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(txt + ' ' + currentTrip.value.destination)}`)
                };
            }
        }).mount('#app');
    </script>

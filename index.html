<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trip Planner (Debug Fix)</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#F5F5F7">

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Libraries -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'main-bg': 'var(--main-bg)', 
                        'card-bg': '#FFFFFF', 
                        'accent': 'var(--accent)',
                        'accent-light': 'var(--accent-light)',
                        'text-main': '#1F2937', 
                        'input-bg': '#FFFFFF'
                    },
                    boxShadow: { 'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.1)' }
                }
            }
        }
    </script>

    <style>
        :root { --main-bg: #F5F5F7; --accent: #6366f1; --accent-light: #E0E7FF; }
        body { background-color: var(--main-bg); color: var(--text-main); font-family: 'Inter', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; } 
        input, select, textarea { background: var(--input-bg); color: var(--text-main); border: 1px solid #D1D5DB; padding: 0.8rem; border-radius: 0.75rem; font-weight: 600; outline: none; width: 100%; font-size: 15px !important; }
        .input-center { text-align: center; } 
        .input-left { text-align: left; padding-left: 1.2rem; }
        
        /* Loading Screen Styles */
        #app-loading { position: fixed; inset: 0; background: var(--main-bg); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; font-weight: 900; color: #374151; transition: opacity 0.5s; pointer-events: auto; }
        .hidden-load { opacity: 0; pointer-events: none !important; }
        [v-cloak] { display: none; }
        .snap-x { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
    </style>
</head>
<body class="selection:bg-accent selection:text-white">

    <!-- Loading / Error Screen -->
    <div id="app-loading">
        <div class="text-4xl mb-4"><i class="fa-solid fa-plane-up fa-bounce text-accent"></i></div>
        <div id="loading-msg">LOADING...</div>
        <div id="error-console" style="margin-top:20px; color:red; font-size:12px; max-width:80%; text-align:center;"></div>
        <button id="force-btn" onclick="document.getElementById('app-loading').classList.add('hidden-load')" style="display:none; margin-top:20px; padding:10px 20px; background:#ccc; border-radius:10px; font-size:12px;">
            Force Start (Skip)
        </button>
    </div>

    <div id="app" v-cloak class="min-h-screen relative max-w-md mx-auto overflow-hidden flex flex-col bg-main-bg">

        <!-- Login View -->
        <div v-if="!user" class="flex flex-col items-center justify-center h-full p-8 text-center relative bg-white">
            <i class="fa-solid fa-earth-americas text-6xl mb-6 text-accent animate-bounce"></i>
            <h1 class="text-3xl font-black mb-2 text-text-main">TRIP PLANNER</h1>
            <p class="mb-8 text-sm font-bold opacity-60">System Ready</p>
            <button @click="login" class="w-full bg-white border-2 border-gray-200 py-4 rounded-2xl font-black shadow-lg active:scale-95 flex items-center justify-center gap-2 text-text-main">
                <i v-if="firebaseStatus === 'ready'" class="fa-solid fa-rocket text-xl text-accent"></i>
                <i v-else class="fa-solid fa-spinner fa-spin text-xl"></i>
                {{ loginBtnText }}
            </button>
            <p v-if="errorMessage" class="mt-4 text-xs text-red-500 font-bold bg-red-50 p-2 rounded">{{ errorMessage }}</p>
        </div>

        <!-- Main Dashboard (Simplified logic for rendering) -->
        <div v-else class="flex flex-col h-full">
            <!-- Home View -->
            <div v-if="currentView === 'home'" class="p-5 flex flex-col h-full">
                <header class="flex justify-between items-center mb-6 pt-2">
                    <div><h1 class="text-3xl font-black text-text-main">{{ t('trips') }}</h1><div class="h-1.5 w-12 bg-accent mt-1 rounded-full"></div></div>
                    <button @click="logout" class="w-10 h-10 bg-red-50 rounded-full text-red-500"><i class="fa-solid fa-power-off"></i></button>
                </header>
                <div class="flex-1 overflow-y-auto space-y-5 pb-24 scrollbar-hide">
                    <div v-if="loading" class="text-center mt-10 font-bold text-gray-400">Loading Trips...</div>
                    <div v-else-if="trips.length === 0" class="text-center mt-10 font-bold text-gray-400">{{ t('noTrips') }}</div>
                    <div v-for="trip in trips" :key="trip.id" @click="openTrip(trip)" class="bg-white rounded-2xl h-36 relative shadow-soft cursor-pointer overflow-hidden">
                        <img v-if="trip.coverImage" :src="trip.coverImage" class="w-full h-full object-cover opacity-80">
                        <div v-else class="w-full h-full flex items-center justify-center text-gray-300"><i class="fa-solid fa-mountain-sun text-5xl"></i></div>
                        <div class="absolute bottom-3 left-3 bg-black/50 text-white text-xs font-bold px-3 py-1 rounded-full">{{ trip.destination }}</div>
                    </div>
                </div>
                <div class="fixed bottom-6 left-0 right-0 flex justify-center px-4 z-10">
                    <button @click="openNewTripModal" class="w-full max-w-sm bg-accent text-white text-lg font-black py-4 rounded-full shadow-xl">{{ t('newTrip') }}</button>
                </div>
            </div>

            <!-- Dashboard View -->
            <div v-if="currentView === 'dashboard'" class="flex flex-col h-full">
                <div class="p-4 flex justify-between items-center bg-white shadow-sm sticky top-0 z-20">
                    <button @click="backToHome" class="w-10 h-10 flex items-center justify-center text-text-main"><i class="fa-solid fa-arrow-left"></i></button>
                    <h2 class="font-black text-lg">{{ currentTrip.destination }}</h2>
                    <div class="w-10"></div>
                </div>
                <div class="p-4 grid grid-cols-2 gap-3">
                    <div @click="changeToItinerary" class="col-span-2 bg-text-main text-white rounded-2xl h-32 flex items-center justify-center text-2xl font-black">{{ t('itinerary') }}</div>
                    <div @click="currentView='budget_detail'" class="bg-white rounded-2xl h-24 flex items-center justify-center font-bold shadow-soft">{{ t('budget') }}</div>
                    <div @click="currentView='hotels'" class="bg-white rounded-2xl h-24 flex items-center justify-center font-bold shadow-soft">{{ t('hotels') }}</div>
                </div>
            </div>

            <!-- Budget View -->
            <div v-if="currentView === 'budget_detail'" class="h-full flex flex-col">
                <div class="p-4 flex justify-between bg-white shadow-sm"><button @click="currentView='dashboard'"><i class="fa-solid fa-arrow-left"></i></button><h2 class="font-black">{{ t('budget') }}</h2><div class="w-10"></div></div>
                <div class="p-4 text-center mt-10"><button @click="showCalculator=true" class="bg-accent text-white px-6 py-3 rounded-xl font-bold">Open Calculator</button></div>
            </div>
            
             <!-- Hotels View -->
            <div v-if="currentView === 'hotels'" class="h-full flex flex-col">
                 <div class="p-4 flex justify-between bg-white shadow-sm"><button @click="currentView='dashboard'"><i class="fa-solid fa-arrow-left"></i></button><h2 class="font-black">{{ t('hotels') }}</h2><button @click="showAddHotelModal=true" class="text-accent"><i class="fa-solid fa-plus text-xl"></i></button></div>
                 <div class="p-4 space-y-4">
                     <div v-for="(h,i) in (currentTrip.hotels||[])" :key="i" class="bg-white p-4 rounded-xl shadow-soft">
                         <div class="font-bold">{{ h.name }}</div>
                         <div class="text-sm text-gray-500">{{ h.address }}</div>
                     </div>
                 </div>
            </div>

            <!-- Modals (Simplified for Debug) -->
            <div v-if="isModalOpen" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6"><div class="bg-white w-full p-6 rounded-3xl"><input v-model="form.destination" placeholder="Destination" class="mb-4"><input type="date" v-model="form.startDate" class="mb-4"><input type="date" v-model="form.endDate" class="mb-4"><button @click="createCloudTrip" class="w-full bg-accent text-white py-3 rounded-xl font-bold">CREATE</button><button @click="isModalOpen=false" class="w-full mt-2 text-gray-400 py-2">Cancel</button></div></div>
            
            <div v-if="showAddHotelModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6"><div class="bg-white w-full p-6 rounded-3xl"><input v-model="newHotel.name" placeholder="Hotel Name" class="mb-4"><input v-model="newHotel.address" placeholder="Address" class="mb-4"><div class="flex gap-2"><input type="date" v-model="newHotel.checkIn"><input type="date" v-model="newHotel.checkOut"></div><button @click="addHotel" class="w-full bg-accent text-white py-3 rounded-xl font-bold mt-4">ADD</button><button @click="showAddHotelModal=false" class="w-full mt-2 text-gray-400">Cancel</button></div></div>

            <div v-if="showCalculator" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6"><div class="bg-white w-full p-6 rounded-3xl"><h3 class="font-bold mb-4">Calculator</h3><input v-model="calcInput" type="number" class="mb-4 text-right text-2xl"><div class="grid grid-cols-4 gap-2"><button v-for="n in [7,8,9,'C',4,5,6,'+',1,2,3,'-',0,'.','=']" :key="n" @click="handleCalc(n)" class="bg-gray-100 p-4 rounded-xl font-bold">{{n}}</button></div><button @click="showCalculator=false" class="w-full mt-4 bg-red-100 text-red-500 py-3 rounded-xl">Close</button></div></div>

        </div>
    </div>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCp3-jUSRISCLXLgky_N25H1xjYuUC3jaI",
            authDomain: "travel-8eaef.firebaseapp.com",
            projectId: "travel-8eaef",
            storageBucket: "travel-8eaef.firebasestorage.app",
            messagingSenderId: "151062172132",
            appId: "1:151062172132:web:9bcda7d1de3eec31b037f1",
            measurementId: "G-CCGZFCJYQ8"
        };

        // 安全日誌紀錄
        function reportError(msg) {
            console.error(msg);
            document.getElementById('error-console').innerText = msg;
            document.getElementById('force-btn').style.display = 'block';
        }

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            // 將 Firebase 掛載到 window
            window.fb = { auth, db, signInAnonymously, signOut, onAuthStateChanged, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, arrayUnion, getDoc };
            
            // 發送事件，並設置全域標記
            window.isFirebaseReady = true;
            window.dispatchEvent(new Event('firebase-ready'));
            console.log("Firebase initialized successfully");

        } catch (e) {
            reportError("Firebase Init Error: " + e.message);
        }
    </script>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        const i18n = { 'zh-TW': { trips:'我的行程', newTrip:'新增行程', noTrips:'無行程', itinerary:'每日行程', budget:'記帳', hotels:'住宿' } };

        createApp({
            setup() {
                const user = ref(null);
                const trips = ref([]);
                const currentTrip = ref({});
                const currentView = ref('home');
                const loading = ref(false);
                const firebaseStatus = ref('connecting');
                const errorMessage = ref('');
                
                // Modals
                const isModalOpen = ref(false);
                const showAddHotelModal = ref(false);
                const showCalculator = ref(false);
                
                // Forms
                const form = ref({ destination:'', startDate:'', endDate:'' });
                const newHotel = ref({ name:'', address:'', checkIn:'', checkOut:'' });
                const calcInput = ref('');

                // Helper
                const t = (k) => (i18n['zh-TW'][k] || k);
                const loginBtnText = computed(() => firebaseStatus.value === 'connecting' ? 'Connecting...' : 'START');

                // 核心啟動邏輯
                const initApp = () => {
                    if (window.fb && window.fb.auth) {
                        firebaseStatus.value = 'ready';
                        document.getElementById('app-loading').classList.add('hidden-load');
                        
                        window.fb.onAuthStateChanged(window.fb.auth, (u) => {
                            user.value = u;
                            if(u) loadTrips();
                        });
                    } else {
                        console.log("Waiting for Firebase...");
                    }
                };

                onMounted(() => {
                    // 1. 嘗試直接啟動
                    if (window.isFirebaseReady) {
                        initApp();
                    } else {
                        // 2. 監聽事件
                        window.addEventListener('firebase-ready', initApp);
                        
                        // 3. 設置保底檢查 (每 500ms 檢查一次)
                        const checkInterval = setInterval(() => {
                            if (window.fb) {
                                initApp();
                                clearInterval(checkInterval);
                            }
                        }, 500);
                        
                        // 4. 4秒後強制關閉載入畫面 (避免永久卡死)
                        setTimeout(() => {
                            const loadScreen = document.getElementById('app-loading');
                            if(loadScreen && !loadScreen.classList.contains('hidden-load')) {
                                document.getElementById('loading-msg').innerText = "Network Slow...";
                                document.getElementById('force-btn').style.display = 'block';
                            }
                        }, 4000);
                    }
                });

                const login = async () => {
                    try {
                        if(!window.fb) throw new Error("Firebase not ready");
                        await window.fb.signInAnonymously(window.fb.auth);
                    } catch (e) {
                        errorMessage.value = e.message;
                        // 如果是網域錯誤，彈出警告
                        if(e.code === 'auth/unauthorized-domain') {
                            alert("網域錯誤：請去 Firebase Console -> Authentication -> Settings -> Authorized Domains 加入你的 Github 網址");
                        } else {
                            alert("Login Error: " + e.message);
                        }
                    }
                };

                const logout = () => window.fb.signOut(window.fb.auth);

                const loadTrips = () => {
                    loading.value = true;
                    const q = window.fb.query(window.fb.collection(window.fb.db, "trips"), window.fb.where("members", "array-contains", user.value.uid));
                    window.fb.onSnapshot(q, (snap) => {
                        trips.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        loading.value = false;
                    });
                };

                const createCloudTrip = async () => {
                    if(!form.value.destination) return;
                    await window.fb.addDoc(window.fb.collection(window.fb.db, "trips"), { 
                        ...form.value, members: [user.value.uid], itinerary:{}, hotels:[], expenses:[], createdAt: Date.now() 
                    });
                    isModalOpen.value = false;
                };

                const openTrip = (trip) => {
                    window.fb.onSnapshot(window.fb.doc(window.fb.db, "trips", trip.id), (doc) => {
                        if(doc.exists()) currentTrip.value = { id: doc.id, ...doc.data() };
                    });
                    currentView.value = 'dashboard';
                };
                
                const addHotel = async () => {
                    if(!currentTrip.value.hotels) currentTrip.value.hotels = [];
                    currentTrip.value.hotels.push({...newHotel.value});
                    await window.fb.updateDoc(window.fb.doc(window.fb.db, "trips", currentTrip.value.id), { hotels: currentTrip.value.hotels });
                    showAddHotelModal.value = false;
                    newHotel.value = { name:'', address:'', checkIn:'', checkOut:'' };
                };
                
                const handleCalc = (n) => {
                    if(n==='C') calcInput.value='';
                    else if(n==='=') { /* logic skipped for brevity */ }
                    else calcInput.value += n;
                }

                return {
                    user, login, logout, trips, currentTrip, currentView, loading, firebaseStatus, errorMessage, loginBtnText, t,
                    isModalOpen, showAddHotelModal, showCalculator,
                    form, newHotel, calcInput,
                    openNewTripModal: () => isModalOpen.value=true,
                    createCloudTrip, openTrip, addHotel, handleCalc,
                    backToHome: () => { currentView.value='home'; loadTrips(); },
                    changeToItinerary: () => currentView.value='itinerary'
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
